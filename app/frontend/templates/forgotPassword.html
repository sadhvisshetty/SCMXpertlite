<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>SCMXPertLite - Forgot Password</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/static/forgotPassword.css" />
</head>
<body>
    <div class="Header">
        <h2 class="text-center"><b>SCMXPertLite</b></h2>
        <h3 class="text-center"><b>Reset Your Password</b></h3>
    </div>

    <div class="text-center">
        {% if message %}
            <div class="alert alert-success" role="alert">{{ message }}</div>
        {% endif %}
        {% if detail %}
            <div class="alert alert-danger" role="alert">{{ detail }}</div>
        {% endif %}
    </div>

    <div class="container">
        <form id="otpForm" class="mb-4">
            <label for="email">Enter your Email ID to receive OTP<span class="text-danger">*</span></label>
            <input type="email" id="otpEmail" name="email" class="form-control mb-2 otp-email-input" required value="{{ email or '' }}" />
            <button type="submit" class="button-signup">Send OTP</button>
        </form>
    </div>

    <div id="Styling" class="container">
        <form action="/forgotpass" method="post">
            <div class="form-group">
                <label for="email" placeholder="Enter your Email ID">Email<span class="text-danger">*</span></label>
                <input type="email" id="email" name="email" class="form-control" placeholder="Enter your Email ID" value="{{ email or '' }}" required />
            </div>

            <div id="message">
                <h5>Password must contain:</h5>
                <p id="letter" class="invalid">A lowercase letter</p>
                <p id="capital" class="invalid">An uppercase letter</p>
                <p id="number" class="invalid">A number</p>
                <p id="length" class="invalid">Minimum 8 characters</p>
            </div>

            <div class="form-group">
                <label for="password">New Password<span class="text-danger">*</span></label>
                <input type="password" id="password" name="password" class="form-control"
                    placeholder="Enter new password"
                    onfocus="passcheck()"
                    onkeyup="passcheck2()"
                    onblur="passcheck3()" required />
            </div>

            <div class="form-group">
                <label for="confpassword">Confirm New Password<span class="text-danger">*</span></label>
                <input type="password" id="confpassword" name="cnfpassword" class="form-control"
                    placeholder="Re-enter password" onkeyup="passcheck4()" required />
                <div id="wrps"></div>
            </div>

            <div class="form-group">
                <label for="otp">Enter OTP<span class="text-danger">*</span></label>
                <input type="text" id="otp" name="otp" class="form-control" placeholder="Enter OTP" required />
            </div>

            <div class="btn-container">
                <button type="submit" class="button-signup">Submit</button>
                <button type="reset" class="button-clear">Clear</button>
            </div>
        </form>
    </div>

<script>
    const passwordInput = document.getElementById("password");
    const confirmPasswordInput = document.getElementById("confpassword");
    const wrps = document.getElementById("wrps");

    const messageBox = document.getElementById("message");
    const letter = document.getElementById("letter");
    const capital = document.getElementById("capital");
    const number = document.getElementById("number");
    const length = document.getElementById("length");

    function passcheck() {
        messageBox.style.display = "block";
    }

    function passcheck2() {
        const value = passwordInput.value;
        letter.className = /[a-z]/.test(value) ? "valid" : "invalid";
        capital.className = /[A-Z]/.test(value) ? "valid" : "invalid";
        number.className = /[0-9]/.test(value) ? "valid" : "invalid";
        length.className = value.length >= 8 ? "valid" : "invalid";
    }

    function passcheck3() {
        messageBox.style.display = "none";
    }

    function passcheck4() {
        const pass = passwordInput.value;
        const confirm = confirmPasswordInput.value;
        if (pass !== confirm) {
            wrps.innerHTML = "Passwords do not match";
            wrps.style.color = "#cc1f1f";
        } else {
            wrps.innerHTML = "Passwords match";
            wrps.style.color = "green";
        }
    }

    document.getElementById("otpForm").addEventListener("submit", async function(e) {
        e.preventDefault(); 
        const emailInput = document.getElementById("otpEmail");
        const email = emailInput.value;

        try {
            const formData = new FormData();
            formData.append("email", email);

            const response = await fetch("/forgotpass/request", {
                method: "POST",
                headers: {
                    "X-Requested-With": "XMLHttpRequest"
                },
                body: formData,
            });

            const data = await response.json();

            if (response.ok) {
                alert(data.message);
            } else {
                alert(data.error || "Error sending OTP.");
            }
        } catch (error) {
            alert("Network error. Please try again.");
            console.error(error);
        }
    });
</script>
</body>
</html>
