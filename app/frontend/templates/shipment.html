<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SCMXPertLite-New Shipment</title>

  <!-- Bootstrap + Font Awesome -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="../static/shipment.css" />

  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
</head>
<body>

<!-- Navbar -->
<nav class="navbar">
  <ul class="navbar-nav">
    <li class="nav-item"><a class="nav-link text-white" href="/dashboard"><i class="fa-solid fa-chart-column"></i>Dashboard</a></li>
    <li class="nav-item"><a class="nav-link text-white" href="/MyAccount"><i class="fas fa-user-circle me-1"></i>My Account</a></li>
    <li class="nav-item"><a class="nav-link text-white" href="/shipment"><i class="fa-solid fa-truck-fast"></i>Shipment</a></li>
    <li class="nav-item"><a class="nav-link text-white active" href="/myShipment"><i class="fa-solid fa-cart-arrow-down"></i>My Shipment</a></li>
    {% if user.role == "Admin" %}
      <a class="nav-link text-white" href="/deviceData"><i class="fas fa-database me-1"></i>Device Data</a>
    {% else %}
      <button type="button" class="nav-link text-muted" style="cursor: not-allowed;" disabled>
        <i class="fas fa-database me-1"></i>Device Data
      </button>
    {% endif %}
  </ul>
  <a href="/logout" class="navbar-logout"><i class="fas fa-sign-out-alt me-1"></i>Logout</a>
</nav>

<!-- Greeting -->
<div class="greet">Hi {{ user.username }}, Welcome to New Shipment</div>

<!-- Shipment Form -->
<div class="container">
  <div class="content w-100">
    <form id="shipmentForm" class="p-4">
      <div class="form-row">
        <!-- Shipment Number -->
        <div class="form-group col-md-6">
          <label for="shipmentNumber">Shipment Number<span class="text-danger">*</span></label>
          <input type="text" id="shipmentNumber" class="form-control" required />
          <small id="shipmentError" class="form-text text-danger"></small>
        </div>

        <!-- Container Number -->
        <div class="form-group col-md-6">
          <label for="containerNumber">Container Number<span class="text-danger">*</span></label>
          <input type="text" id="containerNumber" class="form-control" required />
        </div>

        <!-- Route Details -->
        <div class="form-group col-md-6">
          <label for="routeDetails">Route Details<span class="text-danger">*</span></label>
          <select id="routeDetails" class="form-control" required>
            <option value="">Select Route</option>
            <option value="Chennai-Bangalore">Bengaluru → Chennai</option>
            <option value="Mumbai-Delhi">Mumbai → Delhi</option>
            <option value="Hyderabad-Pune">Hyderabad → Pune</option>
            <option value="Kolkata-Guwahati">Kolkata → Guwahati</option>
            <option value="Delhi-Dubai">Delhi → Dubai (UAE)</option>
            <option value="Mumbai-Singapore">Mumbai → Singapore</option>
            <option value="Chennai-Colombo">Chennai → Colombo</option>
            <option value="Bangalore-Frankfurt">Bengaluru → Frankfurt</option>
            <option value="Ahmedabad-Kathmandu">Ahmedabad → Kathmandu</option>
            <option value="Delhi-NewYork">Delhi → New York</option>
          </select>
        </div>

        <!-- Goods Type -->
        <div class="form-group col-md-6">
          <label for="goodsType">Goods Type<span class="text-danger">*</span></label>
          <select id="goodsType" class="form-control" required>
            <option value="">Select Goods</option>
            <option value="Electronics">Electronics</option>
            <option value="Pharmaceuticals">Pharmaceuticals</option>
            <option value="AutomobileParts">Automobile Parts</option>
            <option value="TextilesGarments">Textiles & Garments</option>
            <option value="AgriculturalProduce">Agricultural Produce</option>
            <option value="IndustrialMachinery">Industrial Machinery</option>
            <option value="Beverages">Beverages</option>
            <option value="ChemicalsHazardous">Chemicals</option>
            <option value="FurnitureHomeAppliances">Furniture</option>
            <option value="ConstructionMaterials">Construction</option>
          </select>
        </div>

        <!-- Device -->
        <div class="form-group col-md-6">
          <label for="device">Device<span class="text-danger">*</span></label>
          <select id="device" class="form-control" required>
            <option value="">Select Device</option>
            <option value="GPSTracker">GPS Tracker</option>
            <option value="BarcodeScanner">Barcode Scanner</option>
            <option value="TemperatureSensor">Temperature Sensor</option>
            <option value="RFIDReader">RFID Reader</option>
            <option value="MobileDataTerminal">Mobile Data Terminal</option>
          </select>
        </div>

        <!-- Expected Delivery Date -->
        <div class="form-group col-md-6">
          <label for="expectedDeliveryDate">Expected Delivery Date<span class="text-danger">*</span></label>
          <input type="date" id="expectedDeliveryDate" class="form-control" required />
        </div>

        <!-- Other Fields -->
        <div class="form-group col-md-6"><label for="poNumber">PO Number*</label><input type="text" id="poNumber" class="form-control" required /></div>
        <div class="form-group col-md-6"><label for="deliveryNumber">Delivery Number*</label><input type="text" id="deliveryNumber" class="form-control" required /></div>
        <div class="form-group col-md-6"><label for="ndcNumber">NDC Number*</label><input type="text" id="ndcNumber" class="form-control" required /></div>
        <div class="form-group col-md-6"><label for="batchId">Batch ID*</label><input type="text" id="batchId" class="form-control" required /></div>
        <div class="form-group col-md-6"><label for="serialNumber">Serial Number of Goods*</label><input type="text" id="serialNumber" class="form-control" required /></div>
        <div class="form-group col-md-6"><label for="shipmentDescription">Shipment Description*</label><input type="text" id="shipmentDescription" class="form-control" required /></div>
      </div>

      <div class="form-group text-center mt-4" id="b-button">
        <button type="submit" class="btn btn-primary">Create Shipment</button>
        <button type="reset" class="btn btn-danger">Clear Details</button>
      </div>
    </form>
  </div>
</div>

<!-- JavaScript -->
<!-- JavaScript -->
<script>
  console.log("Script loaded");

  const shipmentNumInput = document.getElementById('shipmentNumber');
  const shipmentError = document.getElementById('shipmentError');

  // Real-time validation on input
  shipmentNumInput.addEventListener('input', () => {
    const val = shipmentNumInput.value.trim();

    // Only digits allowed (empty allowed while typing)
    if (!/^\d*$/.test(val)) {
      shipmentError.innerHTML = "◉ Shipment Number must be numeric.";
      return;
    }

    // Max 7 digits only
    if (val.length > 7) {
      shipmentError.innerHTML = "◉ Shipment Number cannot exceed 7 digits.";
      return;
    }

    // Clear error if all good
    shipmentError.innerHTML = "";
  });

  document.getElementById('shipmentForm').addEventListener('submit', async function (e) {
    e.preventDefault();

    const shipmentNum = shipmentNumInput.value.trim();
    shipmentError.innerHTML = "";

    // Final validation: must be exactly 7 digits
    if (!/^\d{7}$/.test(shipmentNum)) {
      shipmentError.innerHTML = "◉ Shipment Number must be exactly 7 digits.";
      shipmentNumInput.focus();
      return;
    }

    // Build the shipment data object
    const data = {
      ShipNum: parseInt(shipmentNum),
      ContNum: parseInt(document.getElementById('containerNumber').value),
      RoutDet: document.getElementById('routeDetails').value,
      GoodType: document.getElementById('goodsType').value,
      Device: document.getElementById('device').value,
      ExpDelDate: document.getElementById('expectedDeliveryDate').value,
      PoNum: parseInt(document.getElementById('poNumber').value),
      DelNum: parseInt(document.getElementById('deliveryNumber').value),
      NdcNum: parseInt(document.getElementById('ndcNumber').value),
      BatchId: parseInt(document.getElementById('batchId').value),
      SeNumOfGoods: document.getElementById('serialNumber').value,
      ShipDes: document.getElementById('shipmentDescription').value
    };

    try {
      const response = await fetch('/shipment', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'include', 
        body: JSON.stringify(data)
      });

      if (response.ok) {
        alert('Shipment Created Successfully!');
        this.reset();
      } else {
        const err = await response.json();

        // Handle detailed validation errors array if present
        if (Array.isArray(err.detail)) {
          const messages = err.detail.map(e => e.msg).join('; ');
          alert('Error: ' + messages);
        } else {
          alert('Error: ' + (err.detail || 'Failed to create shipment.'));
        }
      }
    } catch (error) {
      alert('Error submitting shipment: ' + error.message);
    }
  });

  // Block past dates in calendar
  const dateInput = document.getElementById('expectedDeliveryDate');
  const today = new Date().toISOString().split('T')[0];
  dateInput.min = today;
</script>

</body>
</html>
