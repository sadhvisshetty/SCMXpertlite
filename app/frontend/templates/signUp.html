<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SCMXPertLite - Sign Up</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="../static/signUp.css" />
</head>
<body style="background-image: url('/images/background.jpg');">

  <div class="signup-container">
    <div class="form-box">
      <h2>SCMXPertLite</h2>
      <h4>Create Account</h4>
      <form id="signupForm" novalidate>
        <div class="form-group">
          <label for="name">What should we call you?<span class="text-danger">*</span></label>
          <input type="text" id="name" name="username" class="form-control" required />
          <div id="nameError" class="validation-message">Please enter your full name.</div>
        </div>

        <div class="form-group">
          <label for="email">Email Address<span class="text-danger">*</span></label>
          <input type="email" id="email" name="email" class="form-control" required />
          <div id="emailError" class="validation-message">Please enter a valid email.</div>
        </div>

        <div class="form-group">
          <label for="password">Create a New Password<span class="text-danger">*</span></label>
          <input type="password" id="password" name="password" class="form-control" required placeholder="At least 8 chars, uppercase, lowercase & number"/>
          <div id="passwordError" class="validation-message">Password must contain at least 8 characters, one uppercase letter, one lowercase letter, and one number.</div>
        </div>

        <div class="form-group">
          <label for="confirm">Confirm New Password<span class="text-danger">*</span></label>
          <input type="password" id="confirm" name="confirm" class="form-control" required />
          <div id="confirmError" class="validation-message">Passwords do not match.</div>
        </div>

        <div class="form-check">
          <input type="checkbox" id="terms" required />
          <label for="terms" style=" margin-left: 10px;">I have read and accept the Privacy & Policy</label>
        </div>
        <div id="termsError" class="validation-message">You must accept the terms.</div>

        <button type="submit" class="btn">Sign Up</button>

        <p class="text-center mt-3">Already have an account? <a href="Login" class="signin-link">Sign In</a></p>
      </form>
    </div>
  </div>

  <script>
    const $ = id => document.getElementById(id), form = $('signupForm'),
      showErr = (cond, el) => el.style.display = cond ? 'none' : 'block';

    const validateEmail = e => /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(e),
          validatePass = p => /^(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}$/.test(p);

    ['email', 'password', 'confirm'].forEach(id => 
      $(id).addEventListener('input', () => {
        if (id === 'email') showErr(validateEmail($(id).value), $('emailError'));
        if (id === 'password') showErr(validatePass($(id).value), $('passwordError'));
        if (id === 'confirm') showErr($(id).value === $('password').value, $('confirmError'));
      }));

    form.addEventListener('submit', async e => {
      e.preventDefault();
      let valid = true;

      if (!$('name').value.trim()) $('nameError').style.display = (valid = false, 'block'); else $('nameError').style.display = 'none';
      if (!validateEmail($('email').value)) $('emailError').style.display = (valid = false, 'block'); else $('emailError').style.display = 'none';
      if (!validatePass($('password').value)) $('passwordError').style.display = (valid = false, 'block'); else $('passwordError').style.display = 'none';
      if ($('confirm').value !== $('password').value || !$('confirm').value) $('confirmError').style.display = (valid = false, 'block'); else $('confirmError').style.display = 'none';
      if (!$('terms').checked) $('termsError').style.display = (valid = false, 'block'); else $('termsError').style.display = 'none';
      if (!valid) return;

      const user = {
        username: $('name').value.trim(),
        email: $('email').value.trim(),
        password: $('password').value,
        permissions: ["User"]
      };

      try {
        const res = await fetch('/signUp', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(user)
        });
        if (!res.ok) {
          const err = await res.json();
          throw new Error(typeof err.detail === 'string' ? err.detail : JSON.stringify(err.detail || err.message || "Signup failed"));
        }
        alert('Signup successful! Please login.');
        window.location.href = '/Login';
      } catch (err) {
        alert(err.message);
      }
    });
  </script>
</body>
</html>
